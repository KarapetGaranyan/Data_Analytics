{% extends 'base.html' %}

{% block title %}AI Chats{% endblock %}

{% block content %}
{% if user.is_authenticated %}
    <div class="container-fluid mt-4">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10 col-xl-8">
                <h1 class="text-center mb-4">AI Chats</h1>
                
                <!-- –°—Ç–∞—Ç—É—Å –±–∞–ª–∞–Ω—Å–∞ -->
                <div class="alert alert-info text-center">
                    {% if user.get_available_messages > 0 %}
                        –£ –≤–∞—Å –æ—Å—Ç–∞–ª–æ—Å—å <strong>{{ user.get_available_messages }}</strong> –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                    {% else %}
                        –ë–∞–ª–∞–Ω—Å: <strong>{{ user.balance }} ‚ÇΩ</strong>
                        (—Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è: 2 ‚ÇΩ)
                        {% if user.balance < 2 %}
                            <a href="/accounts/topup/" class="btn btn-sm btn-warning ms-2">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</a>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ –∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">–ú–æ–¥–µ–ª—å –ò–ò:</label>
                        <select class="form-select" id="modelSelect">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å...</option>
                            {% for model in models %}
                                <option value="{{ model.id }}">{{ model.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç:</label>
                        <select class="form-select" id="assistantSelect">
                            <option value="">–ë–µ–∑ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</option>
                            {% for assistant in assistants %}
                                <option value="{{ assistant.id }}">{{ assistant.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- –û–ø–∏—Å–∞–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ -->
                <div id="assistantDescription" class="alert alert-info alert-dismissible fade show" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1050; max-width: 600px; margin: 0;">
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    <span id="assistantDescriptionText"></span>
                </div>

                <!-- –ß–∞—Ç -->
                <div class="chat-container" id="chatContainer"></div>

            <!-- –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="input-group mt-3 mb-4">
                <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="previewImage()">
                <button class="btn btn-outline-secondary" onclick="document.getElementById('imageInput').click()">üì∑</button>
                <input type="text" class="form-control form-control-lg" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="btn btn-primary btn-lg" id="sendButton" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button class="btn btn-outline-secondary btn-lg" id="continueButton" onclick="continueMessage()" style="display: none;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>

            <!-- Preview –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
            <div id="imagePreview" style="display:none" class="mb-3">
                <img id="previewImg" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
                <button onclick="clearImage()" class="btn btn-sm btn-danger ms-2">‚úï</button>
            </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        .chat-container {
            height: calc(100vh - 400px);
            min-height: 400px;
            max-height: 700px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            margin-left: 20%;
        }
        .ai-message {
            background-color: white;
            border: 1px solid #dee2e6;
            margin-right: 20%;
        }
        .ai-message pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 0.75rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .ai-message code {
            background-color: #f8f9fa;
            color: #e83e8c;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }
        .ai-message pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
        }
        .ai-message h1, .ai-message h2, .ai-message h3,
        .ai-message h4, .ai-message h5, .ai-message h6 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .ai-message ul, .ai-message ol {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        .ai-message blockquote {
            border-left: 4px solid #007bff;
            padding-left: 1rem;
            margin: 0.5rem 0;
            color: #6c757d;
        }
        .loading {
            text-align: center;
            color: #6c757d;
        }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 450px);
                min-height: 300px;
            }

            #assistantDescription {
                left: 10px !important;
                right: 10px !important;
                transform: none !important;
                max-width: none !important;
            }

            .container-fluid {
                padding-left: 15px;
                padding-right: 15px;
            }

            h1 {
                font-size: 2rem;
                margin-bottom: 1.5rem;
            }
        }

        @media (min-width: 1400px) {
            .chat-container {
                height: calc(100vh - 380px);
            }
        }
    </style>

    <script>
        const assistants = {
            {% for assistant in assistants %}
            {{ assistant.id }}: "{{ assistant.description }}",
            {% endfor %}
        };

        let lastAIMessage = null;
        let conversationHistory = [];

        // –ü–æ–∫–∞–∑ –æ–ø–∏—Å–∞–Ω–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        document.getElementById('assistantSelect').addEventListener('change', function() {
            const assistantId = this.value;
            const description = document.getElementById('assistantDescription');
            const descriptionText = document.getElementById('assistantDescriptionText');

            if (assistantId && assistants[assistantId]) {
                descriptionText.textContent = assistants[assistantId];
                description.style.display = 'block';

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    if (description.style.display !== 'none') {
                        const bsAlert = new bootstrap.Alert(description);
                        bsAlert.close();
                    }
                }, 3000);
            } else {
                description.style.display = 'none';
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function addMessage(content, isUser, isAppend = false) {
            const chatContainer = document.getElementById('chatContainer');

            if (isAppend && lastAIMessage) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –ò–ò
                const existingContent = lastAIMessage.getAttribute('data-raw-content') || '';
                const newContent = existingContent + content;
                lastAIMessage.setAttribute('data-raw-content', newContent);
                lastAIMessage.innerHTML = marked.parse(newContent);
                lastAIMessage.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;

                if (isUser) {
                    messageDiv.textContent = content;
                } else {
                    messageDiv.setAttribute('data-raw-content', content);
                    messageDiv.innerHTML = marked.parse(content);
                    messageDiv.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    lastAIMessage = messageDiv;
                }

                chatContainer.appendChild(messageDiv);
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addLoadingMessage() {
            const chatContainer = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message loading';
            loadingDiv.innerHTML = '<em>–ò–ò –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å... (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 2 –º–∏–Ω—É—Ç)</em>';
            loadingDiv.id = 'loadingMessage';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingDiv;
        }

        function removeLoadingMessage() {
            const loading = document.getElementById('loadingMessage');
            if (loading) {
                loading.remove();
            }
        }

        function showContinueButton() {
            document.getElementById('continueButton').style.display = 'block';
        }

        function hideContinueButton() {
            document.getElementById('continueButton').style.display = 'none';
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message) return;

            await processMessage(message, false);
        }

        async function continueMessage() {
            await processMessage("–ü—Ä–æ–¥–æ–ª–∂–∏", true);
        }

        async function processMessage(message, isContinue) {
            const sendButton = document.getElementById('sendButton');
            const modelId = document.getElementById('modelSelect').value;
            const assistantId = document.getElementById('assistantSelect').value;

            if (!modelId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –ò–ò');
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
            if (!isContinue) {
                conversationHistory.push({ role: 'user', content: message });
                addMessage(message, true);
                document.getElementById('messageInput').value = '';
            } else {
                conversationHistory.push({ role: 'user', content: message });
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            const loading = addLoadingMessage();
            sendButton.disabled = true;
            hideContinueButton();

            try {
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 3 –º–∏–Ω—É—Ç
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000);

                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                body: JSON.stringify({
                    messages: conversationHistory,
                    model_id: parseInt(modelId),
                    assistant_id: assistantId ? parseInt(assistantId) : null,
                    image_id: selectedImageId  // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await response.json();

                removeLoadingMessage();

                if (response.ok) {
                    conversationHistory.push({ role: 'assistant', content: data.response });
                    addMessage(data.response, false, isContinue);
                    showContinueButton();
                } else if (response.status === 401) {
                    addMessage('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.', false);
                    setTimeout(() => window.location.href = '/accounts/login/', 2000);
                } else if (response.status === 402) {
                    addMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å.', false);
                    if (data.need_payment) {
                        setTimeout(() => window.location.href = '/accounts/topup/', 2000);
                    }
                } else {
                    addMessage(`–û—à–∏–±–∫–∞: ${data.error}`, false);
                }
            } catch (error) {
                removeLoadingMessage();
                if (error.name === 'AbortError') {
                    addMessage(`–ó–∞–ø—Ä–æ—Å –ø—Ä–µ—Ä–≤–∞–Ω: —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–∏–π –æ—Ç–≤–µ—Ç (–±–æ–ª–µ–µ 3 –º–∏–Ω—É—Ç)`, false);
                } else {
                    addMessage(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`, false);
                }
            } finally {
                sendButton.disabled = false;
            }
        }

        let selectedImageId = null;

                function previewImage() {
                    const fileInput = document.getElementById('imageInput');
                    const file = fileInput.files[0];

                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            document.getElementById('previewImg').src = e.target.result;
                            document.getElementById('imagePreview').style.display = 'block';
                        };
                        reader.readAsDataURL(file);

                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                        uploadImage(file);
                    }
                }

                async function uploadImage(file) {
                    const formData = new FormData();
                    formData.append('image', file);

                    try {
                        const response = await fetch('/upload-image/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                            },
                            body: formData
                        });

                        if (response.ok) {
                            const data = await response.json();
                            selectedImageId = data.image_id;
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    }
                }

                function clearImage() {
                    document.getElementById('imagePreview').style.display = 'none';
                    document.getElementById('imageInput').value = '';
                    selectedImageId = null;
                }

    </script>

{% else %}
    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <h1 class="display-4 mb-4">AI Chats</h1>
            <p class="lead mb-4">
                –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞–º–∏.
                –í—ã–±–∏—Ä–∞–π—Ç–µ –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–µ–π –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–º–æ—â–Ω–∏–∫–æ–≤.
            </p>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">üéÅ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Å—Ç–∞—Ä—Ç</h5>
                            <p class="card-text">5 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">ü§ñ –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–µ–π</h5>
                            <p class="card-text">GPT, Claude, DeepSeek, Gemini</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">üë®‚Äçüíº –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã</h5>
                            <p class="card-text">–ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç, –ü—Å–∏—Ö–æ–ª–æ–≥, –£—á–∏—Ç–µ–ª—å</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                <a href="/accounts/signup/" class="btn btn-primary btn-lg me-md-2">
                    –ù–∞—á–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ
                </a>
                <a href="/accounts/login/" class="btn btn-outline-primary btn-lg">
                    –í–æ–π—Ç–∏
                </a>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}