<!-- templates/chat/chat.html -->
{% extends 'base.html' %}

{% block title %}–ß–∞—Ç —Å –ò–ò-–ø—Å–∏—Ö–æ–ª–æ–≥–æ–º{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üí¨ –ß–∞—Ç —Å –ò–ò-–ø—Å–∏—Ö–æ–ª–æ–≥–æ–º</h5>
                {% if not is_premium %}
                    <small class="text-muted">
                        –û—Å—Ç–∞–ª–æ—Å—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: <span id="messages-left">{{ free_messages_left }}</span>
                    </small>
                {% endif %}
            </div>

            <div class="card-body p-0">
                <div id="chat-messages" class="chat-container">
                    {% if messages %}
                        {% for msg in messages %}
                            <div class="message {% if msg.is_user %}user-message{% else %}ai-message{% endif %}">
                                <strong>{% if msg.is_user %}–í—ã:{% else %}–ü—Å–∏—Ö–æ–ª–æ–≥:{% endif %}</strong><br>
                                {{ msg.content|linebreaks }}
                                <small class="text-muted d-block mt-1">{{ msg.timestamp|date:"H:i" }}</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="ai-message message">
                            <strong>–ü—Å–∏—Ö–æ–ª–æ–≥:</strong><br>
                            –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ò–ò-–ø—Å–∏—Ö–æ–ª–æ–≥. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç? –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –≤—ã—Å–ª—É—à–∞—Ç—å –∏ –ø–æ–º–æ—á—å.
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card-footer">
                <div id="message-form">
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control"
                               placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                               {% if not is_premium and free_messages_left <= 0 %}disabled{% endif %}>
                        <button id="send-btn" class="btn btn-primary" type="button"
                                {% if not is_premium and free_messages_left <= 0 %}disabled{% endif %}>
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>

                {% if not is_premium and free_messages_left <= 0 %}
                    <div class="mt-3 text-center">
                        <div class="alert alert-warning">
                            –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                        </div>
                        <a href="{% url 'upgrade' %}" class="btn btn-success">
                            üöÄ –ü–æ–ª—É—á–∏—Ç—å Premium –¥–æ—Å—Ç—É–ø
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const messageInput = document.getElementById('message-input');
const sendBtn = document.getElementById('send-btn');
const chatMessages = document.getElementById('chat-messages');
const messagesLeftSpan = document.getElementById('messages-left');

function addMessage(content, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;

    const now = new Date();
    const timeStr = now.getHours().toString().padStart(2, '0') + ':' +
                   now.getMinutes().toString().padStart(2, '0');

    messageDiv.innerHTML = `
        <strong>${isUser ? '–í—ã:' : '–ü—Å–∏—Ö–æ–ª–æ–≥:'}</strong><br>
        ${content.replace(/\n/g, '<br>')}
        <small class="text-muted d-block mt-1">${timeStr}</small>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendMessage() {
    const message = messageInput.value.trim();
    if (!message) return;

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥
    sendBtn.disabled = true;
    messageInput.disabled = true;

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(message, true);
    messageInput.value = '';

    try {
        const response = await fetch('/api/send-message/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ message })
        });

        const data = await response.json();

        if (response.ok) {
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ò–ò
            addMessage(data.ai_response);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            if (messagesLeftSpan) {
                messagesLeftSpan.textContent = data.free_messages_left;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (!data.is_premium && data.free_messages_left <= 0) {
                location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–∫–∞–∑–∞ –±–ª–æ–∫–∞ –∞–ø–≥—Ä–µ–π–¥–∞
            }
        } else {
            if (data.need_premium) {
                location.reload();
            } else {
                addMessage('–û—à–∏–±–∫–∞: ' + data.error);
            }
        }
    } catch (error) {
        addMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
    }

    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥
    sendBtn.disabled = false;
    messageInput.disabled = false;
    messageInput.focus();
}

// –°–æ–±—ã—Ç–∏—è
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

// –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
messageInput.focus();

// –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
chatMessages.scrollTop = chatMessages.scrollHeight;
</script>
{% endblock %}